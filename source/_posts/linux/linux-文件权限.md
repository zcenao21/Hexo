---
title: 文件及用户权限
date: 2020-03-10 00:31:21
tags:
    - Linux
    - 文件
    - 权限
categories: 
    - Linux
---



# 概述

计算机最重要的两大部分：存储和计算。存储分永久性存储（例如文件）和短暂的存储（例如内存）。永久性存储我们接触最多的就是文件了。<!--more-->大多数人都用过word，肯定都有过word没保存，工作白干了这种尴尬的事情，这就是临时的修改没有保存到文件中的缘故。文件作为重要信息载体，安全性、共享性都非常重要。我们是否可以通过linux的文件系统做到以下事情？

1.不同用户对同一文件有不同权限

2.是否可以分配某个权限给一群人

3.是否可以针对某个用户做权限限制

4.为了文件安全性，是否可以设置文件只能添加或者其他权限如不能删除改名

5.只让用户做指定的事情

带着这些问题，我们将分3个部分进行介绍。



# 基础权限

网上盗一张图：

![image.png](https://i.loli.net/2020/03/12/Nwa34uJdEZFgW2H.png)

linux列出文件的命令`ls -l`执行一下，得到如下结果

![](https://i.loli.net/2020/03/12/HvxWYgweRpmGf6l.png)

<center>图1</center>
表示当前目录下只有一个test.txt文件。最前面的含义可以用第一张图来解释。第一个数字表示第几个符号

`-rw-rw-r--`

1: -表示文件类型是文件。文件夹用d表示，l表示链接文件。最常用的就是这三个。接下来每3个一组

2: r对于will用户可读（`ll`显示的结果第三列表示所有者用户）

3: w对于will用户可写

4: -对于will用户不可执行

接下来的3个表示对于用户组will可读可写不可执行(`ll`显示的结果第四列表示所在用户组)

最后的3个表示对于其他用户可读不可写不可执行

> 第一个问题就解决了。当以will用户登陆使用linux时，对于test.txt文件就有两个权限读和写; 若非will用户组的其他用户登陆linux时，对于test.txt文件就只有读的权限。

>第二个问题也解决了。如何给一群人一个权限？拉到一个用户组就可以了。

对于文件和文件夹，rwx的权限含义是不一样的，如下表

|      | r            | w            | x            |
| ---- | ------------ | ------------ | ------------ |
| 文件 | 读取文件内容 | 修改文件内容 | 执行文件内容 |
| 目录 | 读到文件名   | 修改文件名   | 进入该目录   |

对于目录权限的理解：若没有x权限，就无法进入该目录;若没有r权限，则文件夹中内容不可见。可以将文件夹理解成一个盒子，x权限相当于我们有了钥匙，但是是在黑夜中打开，看不见里面的内容，r权限就是一道光，照亮盒子，让我们看到里面的小盒子（子文件夹）和小糖果、小文具（文件）。



# ACL权限

如上一部分所介绍的，可以针对某个用户组设置权限，但是如果想针对某个用户做限制可以做到吗？比如一个项目组正在做一个项目，这些人都属于一个用户组。对于其他人，项目文件不可见。现在有个人非此项目人员，但又有查看这些项目文件的需求怎么办？传统的用户，用户组，其他用户的区分已经没办法做到了。ACL可以帮我们做到！

ACL是Access Control List的英文缩写，现在的unix-like系统一般都会装。如果要确认是否有这个功能，可以使用如下命令：

```
dmsg | grep -i acl
```

### 使用

以示例来说明。以当前用户创建一个文件，再写点东西进去

```
touch testfile

 % ll
总用量 0
-rw-rw-r-- 1 will will 0 4月   1 00:40 testfile

% echo "big data" > testfile
% cat testfile 
big data
```

假设已经有了一个用户tom，这个用户经常恶作剧，所以我们想限制tom这个人不能对这个文件进行修改

```
 % setfacl -m u:tom:r testfile 
 % ll
-rw-rw-r--+ 1 will will 9 4月   1 00:43 testfile
```

可以发现在九个字母表示的权限后面多了一个+号，表示有ACL权限设置了。设置ACL的命令为`setfacl`，-m表示设置参数给文件使用，-x表示删除ACL参数，-b表示删除所有的ACL参数。下面验证是否设置成功，即tom能不能修改这个文件

```
% su - tom
$ ls -l
-rw-rw-r--+ 1 will will 9 4月   1 00:43 testfile
$ cat testfile 
big data
$ vim testfile
```

使用vim编辑文件就会提示文件只读，设置成功。

获取ACL设置可以用`getfacl`

```
$ getfacl testfile 
# file: testfile
# owner: will
# group: will
user::rw-
user:tom:r--
group::rw-
mask::rw-
other::r--
```

ACL还可以针对用户组设置，还能设置继承时的文件权限，比如子文件对某用户/某用户组只读

针对用户组设置：`setfacl -m g:user:rwx filename`

设置继承：`setfacl -m d:u:user:rx dirname`

取消ACL：`setfacl -b fielname`

> 第三个问题圆满解决



# 文件隐藏属性

隐藏属性是个啥？可以理解成基本属性的补充。比如我们需要设置某个文件只能添加怎么办？普通的权限设置已经无能为力了，这时候就用到了隐藏属性。

chatttr [+-=] [ai] 文件或目录名称

> a参数表示文件只能增加数据，不能删除也不能修改，只有root有权限设置此权限
>
> i参数表示文件不能删除，改名，设置链接，无法写入或新增数据

lsattr [-adR] 文件或目录

分别用于配置和显示隐藏属性

如下示例，表示设置文件只能添加，妄图写数据报错

```
% sudo chattr +a testfile
% echo "input" > testfile 
不允许的操作: testfile
```

> 第四个问题到这里也解决了！





# 文件特殊权限：SUID/SGID/SBIT

终于来到了最后一类权限。这类权限能干嘛？比如一个普通用户，我们希望他只能执行某个操作。比如Linux修改密码的工作就是/usr/bin/passwd来做的，这个脚本修改的是/etc/shadow里面的东西。然而，对于/etc/shadow这个文件是高度保密的，不然就会出现密码泄露，而且文件权限是--- --- ---，即只有root有权限修改。那么我们平时怎么修改自己的密码？答案就是在执行时获得root权限。

### Set UID

简称SUID。这个就可以实现执行时获得权限的功能，它有如下特性

- SUID仅对二进制程序有效
- 执行者需要对改程序具有x的权限
- 本权限仅在执行程序过程中有效
- 执行者将具有该程序拥有者的权限

拥有SUID权限时，用户权限x变成s。

### Set GID

与SUID不同的是，SGID可以针对文件和目录设置，而且对文件和目录设置时功能不同。

对于文件来说：

- SGID对二进制程序有用
- 程序执行者需要对该程序具备x权限
- 执行者将在执行过程中获得该程序用户组支持

对于目录来说：

- 用户若对此目录具有r和x权限时，该用户能够进入该目录
- 用户在此目录下的有效用户组会变成该目录的用户组
- 用户：若用户在此目录下拥有w权限，则用户所建立的新文件用户组与此目录用户组相同

对于目录的第三个特性非常有用！

当拥有SGID权限时，s会出现在用户组的x位置

### Sticky Bit

简称SBIT。仅针对目录有效

- 当用户对此目录具有w、x权限
- 当用户在该目录下建立文件或目录时，仅有root和自己才有权利增删改该文件，其他人有r权限时可以读。

> 最后一个问题圆满解决！